<script>
    /**
     * Global Helper Functions
     * Extracted from app.js to reduce bundle size.
     */
    window.showLoadingModal = function (e, t = !1, n = 0) { 
        let s = document.getElementById("loadingMessageModal"), 
            i = document.getElementById("loadingMessageText"), 
            o = s ? s.querySelector(".spinner") : null; 
        s && i ? (i.innerHTML = e || "Processing...", o && (o.style.display = t ? "none" : "inline-block"), s.style.display = "flex", s.offsetWidth, s.classList.add("is-visible"), n > 0 && setTimeout(() => hideLoadingModal(), n)) : (console.warn("Loading modal elements not found. Using alert as fallback for message:", e), alert(e || "Processing... Please wait.")) 
    };

    window.hideLoadingModal = function () { 
        let e = document.getElementById("loadingMessageModal"); 
        e && (e.classList.remove("is-visible"), setTimeout(() => { e.classList.contains("is-visible") || (e.style.display = "none") }, 300)) 
    };

    window.setMainGalleryImageFinal = function (e) {
        let t = document.getElementById("galleryMainImageFinal");
        if (t && e) {
            t.src = e;
            // Also update source tags if inside a picture element
            let p = t.closest("picture");
            if (p) {
                // We need to update ALL source tags to the new image URL to ensure the change sticks
                // regardless of the current viewport width.
                let sources = p.querySelectorAll("source");
                for(let i = 0; i < sources.length; i++) {
                    sources[i].srcset = e;
                }
            }
        }
    };

    window.navigateToLocation = function (e, t, n) { 
        let s = parseFloat(e), i = parseFloat(t); 
        if (isNaN(s) || isNaN(i)) { 
            showLoadingModal("Location coordinates for this business are invalid or not available.", !0, 3500), console.error("Invalid coordinates passed to navigateToLocation:", e, t); return 
        } 
        let o = `${s},${i}`, 
            l = `https://www.google.com/maps/search/?api=1&query=${o}`, 
            r = `https://www.google.com/maps/dir/?api=1&destination=${o}&travelmode=driving`; 
        navigator.geolocation ? (showLoadingModal("Getting your location to provide directions to " + (n || "the destination") + "..."), navigator.geolocation.getCurrentPosition(function (e) { hideLoadingModal(), showLoadingModal("Opening Google Maps with directions...", !1, 2e3), setTimeout(() => window.open(`${r}&origin=${e.coords.latitude},${e.coords.longitude}`, "_blank"), 500) }, function (e) { hideLoadingModal(); showLoadingModal(`Could not get your current location (Error: ${e.message}). Opening Google Maps with just the destination: ${n || "the destination"}.`, !0, 4500), setTimeout(() => window.open(l, "_blank"), 500) }, { enableHighAccuracy: !0, timeout: 1e4, maximumAge: 0 })) : (showLoadingModal("Geolocation not supported by this browser. Opening Google Maps with the destination: " + (n || "the destination") + "...", !0, 3500), setTimeout(() => window.open(l, "_blank"), 500)) 
    };

    window.toggleTimeInputs = function (e, t) { 
        let n = document.querySelector(`input[name="schedule[${t}][open_time]"]`), 
            s = document.querySelector(`input[name="schedule[${t}][close_time]"]`), 
            i = document.querySelector(`input[name="schedule[${t}][notes]"]`);
        [n, s, i].forEach(t => { t && (t.disabled = e.checked, e.checked && (t.value = "")) }) 
    };

    /**
     * Main Application Logic
     * Handles Event Listeners, Forms, and Interactive Elements.
     */
    document.addEventListener("DOMContentLoaded", function () {
        ["current-year", "current-year-layout", "current-year-details", "current-year-listings"].forEach(e => { let t = document.getElementById(e); t && (t.textContent = new Date().getFullYear()) }); 
        let e = document.getElementById("hamburgerButton"), t = document.getElementById("mobileNavPanel"), s = document.getElementById("closeMobileNavButton"), i = document.body; 
        e && t && s && (e.addEventListener("click", function () { t.classList.add("is-open"), i.classList.add("mobile-nav-is-open"), this.setAttribute("aria-expanded", "true") }), s.addEventListener("click", function () { t.classList.remove("is-open"), i.classList.remove("mobile-nav-is-open"), e.setAttribute("aria-expanded", "false") }), i.addEventListener("click", function (n) { i.classList.contains("mobile-nav-is-open") && n.target === i && (t.classList.remove("is-open"), i.classList.remove("mobile-nav-is-open"), e.setAttribute("aria-expanded", "false")) }), document.addEventListener("keydown", function (n) { "Escape" === n.key && t.classList.contains("is-open") && (t.classList.remove("is-open"), i.classList.remove("mobile-nav-is-open"), e.setAttribute("aria-expanded", "false")) })); 
        let o = document.getElementById("whatsappShareBtn"); o && o.addEventListener("click", function (e) { e.preventDefault(); let t = this.dataset.url || window.location.href, n = this.dataset.title || document.title, s = "https://api.whatsapp.com/send?text=" + encodeURIComponent(`Check out this listing: ${n} - ${t}`); /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && (s = "https://wa.me/?text=" + encodeURIComponent(`Check out this listing: ${n} - ${t}`)), window.open(s, "_blank") }); 
        let l = document.querySelectorAll('[id^="reportBusinessBtn"], [id^="reportEventBtn"]'), r = document.getElementById("reportModal"), a = document.getElementById("reportBusinessName"), d = document.getElementById("report_item_business_id"), c = document.getElementById("report_item_event_id"), u = document.getElementById("reportItemForm"), m = document.getElementById("report_details"), g = document.getElementById("reportDetailsCharCount"), h = document.getElementById("reportFormMessage"); 
        function p() { if (m && g) { let e = m.value.length, t = parseInt(m.getAttribute("maxlength")) || 150; g.textContent = `${e} / ${t} characters` } } 
        document.querySelectorAll('[data-dismiss="reportModal"]').forEach(e => { e.addEventListener("click", () => { r && (r.classList.remove("is-visible"), setTimeout(() => { r.classList.contains("is-visible") || (r.style.display = "none") }, 300)) }) }), l.length > 0 && r && a && d && c && u && m && g && h ? (l.forEach(e => { e.addEventListener("click", function () { let e = this.dataset.itemName || "this item", t = this.dataset.itemId, n = this.dataset.itemType; if (!t || !n) { console.error("Report Button Error: Item ID or Type not found. Button:", this), showLoadingModal("Could not initiate report. Item identifier missing.", !0, 3500); return } if (a.textContent = e, d.value = "", c.value = "", "business" === n) d.value = t; else if ("event" === n) c.value = t; else { console.error("Report Button Error: Unknown itemType:", n), showLoadingModal("Cannot report this item type.", !0, 3e3); return } h.textContent = "", h.className = "", u.reset(), m && (m.value = ""), p(), r.style.display = "flex", r.offsetWidth, r.classList.add("is-visible") }) }), u.addEventListener("submit", function (e) { e.preventDefault(), showLoadingModal("Submitting your report...", !1); let t = new FormData(this), n = this.action; fetch(n, { method: "POST", headers: { "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]').getAttribute("content"), Accept: "application/json" }, body: t }).then(e => e.json().then(t => ({ status: e.status, ok: e.ok, data: t }))).then(({ status: e, ok: t, data: n }) => { if (hideLoadingModal(), t && n.success) h.textContent = n.message || "Report submitted successfully. Thank you!", h.className = "form-message success", setTimeout(() => { r.classList.contains("is-visible") && (r.classList.remove("is-visible"), setTimeout(() => { r.style.display = "none" }, 300)) }, 3e3); else { let s = "Error: " + (n.message || "Could not submit report."); if (n.errors) { for (let i in s += '<br><small style="text-align:left; display:block; margin-top:5px;">Details:<br>', n.errors) s += n.errors[i].join("<br>") + "<br>"; s += "</small>" } h.innerHTML = s, h.className = "form-message error" } }).catch(e => { hideLoadingModal(), h.textContent = "An unexpected network error occurred. Please try again.", h.className = "form-message error", console.error("Report submission fetch/network error:", e) }) })) : l.length > 0 && console.warn("One or more report modal elements are missing from the DOM. Report functionality may not work."), m && (m.addEventListener("input", p), p()); 
        let y = document.getElementById("likeButton"); y && y.addEventListener("click", function () { if (this.classList.contains("is-processing")) return; this.classList.add("is-processing"), this.dataset.postId; let e = this.dataset.likeUrl; fetch(e, { method: "POST", headers: { "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]').getAttribute("content"), Accept: "application/json", "X-Requested-With": "XMLHttpRequest" } }).then(e => { if (401 === e.status) throw window.location.href = "/login", Error("User not authenticated."); if (!e.ok) throw Error("Network response was not ok."); return e.json() }).then(e => { if (e.success) { let t = document.getElementById("likeCount"); t.textContent = e.likes_count, e.is_liked ? this.classList.add("is-liked") : this.classList.remove("is-liked") } }).catch(e => { console.error("Error toggling like:", e) }).finally(() => { this.classList.remove("is-processing") }) }); 
        let f = document.getElementById("likeButtonBusiness"); f && f.addEventListener("click", function () { if (this.classList.contains("is-processing")) return; this.classList.add("is-processing"); let e = this.dataset.likeUrl; fetch(e, { method: "POST", headers: { "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]').getAttribute("content"), Accept: "application/json", "X-Requested-With": "XMLHttpRequest" } }).then(e => { if (401 === e.status) throw window.location.href = "/login", Error("User not authenticated."); if (!e.ok) throw Error("Network response was not ok."); return e.json() }).then(e => { if (e.success) { let t = document.getElementById("likeCountBusiness"); t.textContent = e.likes_count, this.classList.toggle("is-liked", e.is_liked) } }).catch(e => console.error("Error toggling business like:", e)).finally(() => this.classList.remove("is-processing")) }); 
        let b = document.getElementById("wishlistContainer"); b && b.addEventListener("click", function (e) { let t = e.target.closest("button[data-action]"); if (!t || t.classList.contains("is-processing")) return; t.classList.add("is-processing"); let n = this.dataset.toggleUrl, s = t.dataset.action, i = new FormData; i.append("action", s), i.append("_token", document.querySelector('meta[name="csrf-token"]').getAttribute("content")), showLoadingModal("Updating Wishlist..."), fetch(n, { method: "POST", headers: { Accept: "application/json", "X-Requested-With": "XMLHttpRequest" }, body: i }).then(e => { if (401 === e.status) throw window.location.href = "/login", Error("Unauthenticated."); if (!e.ok) throw Error("Server returned an error."); return e.json() }).then(e => { if (hideLoadingModal(), e.success) { let t = { add: b.querySelector('button[data-action="add"]'), remove: b.querySelector('button[data-action="remove"]'), markDone: b.querySelector('button[data-action="toggle_done"][data-status-target="done"]'), unmarkDone: b.querySelector('button[data-action="toggle_done"][data-status-target="wished"]') }; Object.values(t).forEach(e => { e && (e.style.display = "none") }), e.is_in_wishlist ? (t.remove && (t.remove.style.display = "block"), e.is_done ? t.unmarkDone && (t.unmarkDone.style.display = "block") : t.markDone && (t.markDone.style.display = "block")) : t.add && (t.add.style.display = "block") } }).catch(e => { hideLoadingModal(), console.error("Error updating wishlist:", e), showLoadingModal("Could not update wishlist. Please try again.", !0, 3e3) }).finally(() => { t.classList.remove("is-processing") }) }); 
        let v = document.getElementById("eventWishlistContainer"); v && v.addEventListener("click", function (e) { let t = e.target.closest("button[data-action]"); if (!t || t.classList.contains("is-processing")) return; t.classList.add("is-processing"); let n = this.dataset.toggleUrl, s = t.dataset.action, i = new FormData; i.append("action", s), i.append("_token", document.querySelector('meta[name="csrf-token"]').getAttribute("content")), showLoadingModal("Updating Event List..."), fetch(n, { method: "POST", headers: { Accept: "application/json", "X-Requested-With": "XMLHttpRequest" }, body: i }).then(e => { if (401 === e.status) throw window.location.href = "/login", Error("Unauthenticated."); if (!e.ok) throw Error("Server returned an error."); return e.json() }).then(e => { if (hideLoadingModal(), e.success) { let t = { add: v.querySelector('button[data-action="add"]'), remove: v.querySelector('button[data-action="remove"]'), markDone: v.querySelector('button[data-action="toggle_done"][data-status-target="done"]'), unmarkDone: v.querySelector('button[data-action="toggle_done"][data-status-target="wished"]') }; Object.values(t).forEach(e => { e && (e.style.display = "none") }), e.is_in_wishlist ? (t.remove && (t.remove.style.display = "block", t.remove.innerHTML = `<i class="fas fa-heart mr-2"></i> ${e.is_done ? "In My List (Attended)" : "Remove from My Events"}`), e.is_done ? t.unmarkDone && (t.unmarkDone.style.display = "block") : t.markDone && (t.markDone.style.display = "block")) : t.add && (t.add.style.display = "block") } }).catch(e => { hideLoadingModal(), console.error("Error updating event wishlist:", e), showLoadingModal("Could not update event list. Please try again.", !0, 3e3) }).finally(() => { t.classList.remove("is-processing") }) }); 
        let E = document.getElementById("eventReviewForm"); E && E.addEventListener("submit", function (e) { e.preventDefault(); let t = this, n = t.querySelector('button[type="submit"]'); n.disabled = !0, n.textContent = "Submitting..."; let s = new FormData(t); fetch(t.action, { method: "POST", headers: { Accept: "application/json", "X-Requested-With": "XMLHttpRequest" }, body: s }).then(e => e.json().then(t => ({ ok: e.ok, status: e.status, data: t }))).then(({ ok: e, status: n, data: s }) => { if (e && s.success) { let i = document.getElementById("event-comments-list"), o = document.getElementById("no-event-reviews-message"), l = window.AUTH_USER_ID; if (l && i) { let r = i.querySelectorAll(`[data-user-id="${l}"]`); r.forEach(e => e.remove()) } i && s.html && i.insertAdjacentHTML("afterbegin", s.html), o && o.remove(), t.reset(), showLoadingModal(s.message || "Feedback submitted successfully!", !0, 3e3) } else { let a = Object.values(s.errors).map(e => e.join("<br>")).join("<br>"); showLoadingModal(`Error: <br><small>${a}</small>`, !0, 5e3) } }).catch(e => { console.error("Error submitting review:", e), showLoadingModal("An unexpected network error occurred.", !0, 4e3) }).finally(() => { n.disabled = !1, n.textContent = "Submit Feedback" }) }); 
        let L = document.getElementById("businessReviewForm"); function k(e, t, n) { let s = document.getElementById(e); if (!s) return; let i = document.getElementById(n); if (!i) { console.error(`Hidden input #${n} not found for dropdown: ${e}`); return } let o = s.closest(".searchable-dropdown-group"); if (!o) { console.error(`Dropdown group not found for input: ${e}`); return } let l = o.querySelector(t); if (!l) { console.error(`Dropdown list container '${t}' not found for input: ${e}`); return } let r = Array.from(l.querySelectorAll("div[data-value]")); function a(e = !1) { let t = s.value.toLowerCase(), n = !1; r.forEach(s => { let i = s.textContent.toLowerCase(), o = i.includes(t); s.style.display = e || o ? "" : "none", (e || o) && (n = !0) }), l.style.display = n && (s.value.length > 0 || e) || document.activeElement === s && 0 === s.value.length && e ? "block" : "none" } s.addEventListener("focus", () => { i.value = "", a(!0) }), s.addEventListener("input", () => { i.value = "", a(!1) }), r.forEach(e => { e.addEventListener("click", function () { s.value = this.textContent, i.value = this.dataset.value, l.style.display = "none" }) }), document.addEventListener("click", function (e) { o.contains(e.target) || (l.style.display = "none") }), s.addEventListener("keydown", function (e) { "Escape" === e.key && (l.style.display = "none", s.blur()) }) } L && L.addEventListener("submit", function (e) { e.preventDefault(); let t = this, n = t.querySelector('button[type="submit"]'); n.disabled = !0, n.textContent = "Submitting..."; let s = new FormData(t); fetch(t.action, { method: "POST", headers: { Accept: "application/json", "X-Requested-With": "XMLHttpRequest", "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]').getAttribute("content") }, body: s }).then(e => e.json().then(t => ({ ok: e.ok, status: e.status, data: t }))).then(({ ok: e, status: n, data: s }) => { if (e && s.success) { let i = document.getElementById("business-comments-list"), o = document.getElementById("no-business-reviews-message"), l = window.AUTH_USER_ID; if (l && i) { let r = i.querySelectorAll(`[data-user-id="${l}"]`); r.forEach(e => e.remove()) } i && s.html && i.insertAdjacentHTML("afterbegin", s.html), o && o.remove(), t.reset(), showLoadingModal(s.message || "Review submitted successfully!", !0, 3e3) } else { let a = Object.values(s.errors || { error: [s.message || "An error occurred."] }).map(e => e.join("<br>")).join("<br>"); showLoadingModal(`Error: <br><small>${a}</small>`, !0, 5e3) } }).catch(e => { console.error("Error submitting business review:", e), showLoadingModal("An unexpected network error occurred.", !0, 4e3) }).finally(() => { n.disabled = !1, n.textContent = "Submit Review" }) }), ({
        currentUserLatitude: null, currentUserLongitude: null, elements: {}, locationStorageKey: "discoverkenya_location_preference", visibilityStorageKey: "discoverkenya_visibility_preference", init: function () { this.elements = { permissionMessage: document.getElementById("locationPermissionMessage"), enableLocationBtn: document.getElementById("enableLocationBtn"), controls: document.getElementById("nearbyControls"), slider: document.getElementById("radiusSlider"), radiusDisplay: document.getElementById("radiusValue"), findBtn: document.getElementById("findNearbyBtn"), hideBtn: document.getElementById("hideNearbyBtn"), showContainer: document.getElementById("showNearbyContainer"), showBtn: document.getElementById("showNearbyBtn"), resultsContainer: document.getElementById("nearbyResultsContainer"), resultsGrid: document.getElementById("nearbyPlacesResults"), loadingSpinner: document.getElementById("nearbyLoadingSpinner") }, this.elements.permissionMessage && (this.addEventListeners(), this.checkInitialState()) }, checkInitialState: function () { let e = localStorage.getItem(this.locationStorageKey), t = localStorage.getItem(this.visibilityStorageKey); "granted" === e ? "hidden" === t ? this.elements.showContainer.style.display = "block" : this.requestLocation() : this.elements.permissionMessage.style.display = "block" }, addEventListeners: function () { this.elements.enableLocationBtn?.addEventListener("click", () => this.requestLocation()), this.elements.findBtn?.addEventListener("click", () => this.fetchPlaces()), this.elements.hideBtn?.addEventListener("click", () => this.hideResults()), this.elements.showBtn?.addEventListener("click", () => this.showResults()), this.elements.slider && this.elements.radiusDisplay && (this.elements.slider.oninput = () => { this.elements.radiusDisplay && (this.elements.radiusDisplay.textContent = this.elements.slider.value) }) }, requestLocation: function () { localStorage.setItem(this.visibilityStorageKey, "shown"), this.elements.permissionMessage.style.display = "none", this.elements.showContainer.style.display = "none", this.elements.resultsContainer.style.display = "block", this.elements.loadingSpinner && (this.elements.loadingSpinner.style.display = "block"), this.elements.resultsGrid && (this.elements.resultsGrid.innerHTML = ""), navigator.geolocation.getCurrentPosition(e => { localStorage.setItem(this.locationStorageKey, "granted"), this.currentUserLatitude = e.coords.latitude, this.currentUserLongitude = e.coords.longitude, this.elements.controls && (this.elements.controls.style.display = "block"), this.elements.hideBtn && (this.elements.hideBtn.style.display = "inline-block"), this.fetchPlaces() }, e => { localStorage.setItem(this.locationStorageKey, "denied"), this.elements.loadingSpinner && (this.elements.loadingSpinner.style.display = "none"), this.elements.permissionMessage && (this.elements.permissionMessage.innerHTML = '<p class="text-red-500">Location access was denied. You can re-enable it in your browser settings and refresh the page.</p>', this.elements.permissionMessage.style.display = "block"), this.elements.controls && (this.elements.controls.style.display = "none"), this.elements.resultsContainer && (this.elements.resultsContainer.style.display = "none") }, { enableHighAccuracy: !0, timeout: 15e3, maximumAge: 0 }) }, fetchPlaces: function () {
            if (!this.currentUserLatitude) return; let e = this.elements.slider ? this.elements.slider.value : 25; this.elements.loadingSpinner && (this.elements.loadingSpinner.style.display = "block"), this.elements.resultsGrid && (this.elements.resultsGrid.innerHTML = ""), showLoadingModal("Searching for nearby places..."); let t = `${window.nearbyListingsUrl}?latitude=${this.currentUserLatitude}&longitude=${this.currentUserLongitude}&radius=${e}`; fetch(t, { method: "GET", headers: { Accept: "application/json", "X-Requested-With": "XMLHttpRequest" } }).then(e => { if (!e.ok) throw Error("Network response not OK"); return e.json() }).then(e => {
                if (hideLoadingModal(), e.businesses && e.businesses.length > 0) {
                    let t = ""; e.businesses.forEach(e => {
                        let n = e.name.length > 30 ? e.name.substring(0, 27) + "..." : e.name, s = e.county ? e.county.name : "", i = e.distance ? `<p class="text-xs text-gray-500">Approx. ${parseFloat(e.distance).toFixed(1)} km away</p>` : ""; t += `
                            <div class="listing-card">
                                <a href="/listing/${e.slug}" class="listing-card-link-wrapper">
                                    <div class="card-image-container">
                                        <img src="${e.main_image_url || window.placeholderCardImageUrl}" alt="${e.name}">
                                    </div>
                                    <div class="card-content-area">
                                        <h3>${n}</h3>
                                        <p class="listing-location"><i class="fas fa-map-marker-alt"></i> ${s}</p>
                                        ${i}
                                    </div>
                                </a>
                            </div>
                        `}), this.elements.resultsGrid && (this.elements.resultsGrid.innerHTML = t)
                } else this.elements.resultsGrid && (this.elements.resultsGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No places found. Try increasing the radius.</p>')
            }).catch(e => { }).finally(() => { this.elements.loadingSpinner && (this.elements.loadingSpinner.style.display = "none") })
        }, hideResults: function () { localStorage.setItem(this.visibilityStorageKey, "hidden"), this.elements.controls && (this.elements.controls.style.display = "none"), this.elements.resultsContainer && (this.elements.resultsContainer.style.display = "none"), this.elements.showContainer && (this.elements.showContainer.style.display = "block") }, showResults: function () { localStorage.setItem(this.visibilityStorageKey, "shown"), this.requestLocation() }
    }).init(), document.getElementById("county-search-input") && k("county-search-input", ".county-dropdown-list", "hidden_county_query"), document.getElementById("category-search-input") && k("category-search-input", ".category-dropdown-list", "hidden_category_query"); let $ = document.getElementById("topCategoriesGrid"), w = document.querySelector(".top-categories-list .top-categories-scroller-wrapper"); $ && w && (w.addEventListener("mouseenter", () => { $.style.animationPlayState = "paused" }), w.addEventListener("mouseleave", () => { $.style.animationPlayState = "running" })); 
    // REPLACED 'new n' with 'new SimpleLightbox'
    let B = document.querySelectorAll(".business-lightbox-gallery a"); if (B.length > 0 && void 0 !== window.SimpleLightbox) { try { new window.SimpleLightbox(".business-lightbox-gallery a", { captionDelay: 250, captionsData: "title", loop: !0, navText: ["‹", "›"], closeText: "\xd7" }) } catch (I) { console.error("Error initializing SimpleLightbox:", I) } let S = document.querySelector(".small-thumbnail-item-final.view-all-trigger"); S && S.addEventListener("click", function (e) { e.preventDefault(); let t = document.querySelector(".business-lightbox-gallery a:first-child"); t ? t.click() : console.warn("No images found for lightbox to open.") }) } else document.querySelector(".business-lightbox-gallery") && console.warn("SimpleLightbox library not found, but gallery elements are present."); 
    let C = document.getElementById("filterToggleButton"), x = document.getElementById("filtersSidebar"), M = document.getElementById("closeFiltersButton"), q = document.body; function A(e = "listing") { let t = document.getElementById(`price_slider_input_${e}`), n = document.getElementById(`priceValueDisplay${e.charAt(0).toUpperCase() + e.slice(1)}`); if (t && n) { function s() { n.textContent = "Ksh " + Number(t.value).toLocaleString() } s(), t.addEventListener("input", s) } let i = document.getElementById(`sort-by-select-${e}`), o = document.getElementById(`sort_input_${e}_filter`), l = document.getElementById("filterSortForm"); i && o && l && i.addEventListener("change", function () { o.value = this.value, l.submit() }) } C && x && M && (C.addEventListener("click", function () { x.classList.add("is-open"), q.classList.add("filters-sidebar-open") }), M.addEventListener("click", function () { x.classList.remove("is-open"), q.classList.remove("filters-sidebar-open") }), q.addEventListener("click", function (e) { !q.classList.contains("filters-sidebar-open") || e.target !== q || x.contains(e.target) || C.contains(e.target) || (x.classList.remove("is-open"), q.classList.remove("filters-sidebar-open")) })), document.getElementById("price_slider_input_listing") && A("listing"), document.getElementById("price_slider_input_category") && A("category"), document.getElementById("price_slider_input_facility") && A("facility"), document.getElementById("price_slider_input_tag") && A("tag"); let T = document.getElementById("getGeolocationBtn"), O = document.getElementById("latitude"), R = document.getElementById("longitude"), D = document.getElementById("geolocationMessage"), P = document.getElementById("geolocationHelpNotice"); if (T && O && R && D && P) { let _ = O.value || R.value; O.readOnly = !_, R.readOnly = !_, _ || O.value || R.value || (O.readOnly = !0, R.readOnly = !0), T.addEventListener("click", function () { P && (P.style.display = "none"), showLoadingModal("Fetching your current location..."), O.readOnly = !0, R.readOnly = !0, O.value = "", R.value = "", navigator.geolocation ? navigator.geolocation.getCurrentPosition(function (e) { O.value = e.coords.latitude.toFixed(8), R.value = e.coords.longitude.toFixed(8), fetch(window.reverseGeocodeUrl, { method: "POST", headers: { "Content-Type": "application/json", "X-CSRF-TOKEN": window.csrfToken }, body: JSON.stringify({ latitude: O.value, longitude: R.value }) }).then(e => e.json()).then(e => { if (hideLoadingModal(), e.formatted_address) { let t = "<strong>Location Identified:</strong><br>"; e.place_name && e.place_name !== e.formatted_address ? t += `${e.place_name} <br><small>(${e.formatted_address})</small>` : t += e.formatted_address, t += `<br><small>Coords: Lat: ${e.coordinates.lat}, Lng: ${e.coordinates.lng}. Please verify.</small>`, D.innerHTML = t, D.style.color = "green" } else { let n = e.error || "Unknown error from server."; e.google_error_message && (n = e.google_error_message), D.innerHTML = `<strong>Location Fetched (Coords only):</strong> Lat: ${O.value}, Lng: ${R.value}.<br><small>Could not get address: ${n}. Please verify.</small>`, D.style.color = "darkorange" } O.readOnly = !1, R.readOnly = !1 }).catch(e => { hideLoadingModal(), console.error("Reverse geocoding error:", e), D.innerHTML = `<strong>Location Fetched (Coords only):</strong> Lat: ${O.value}, Lng: ${R.value}.<br><small>Address lookup failed. Please verify.</small>`, D.style.color = "darkorange", O.readOnly = !1, R.readOnly = !1 }) }, function (e) { hideLoadingModal(), O.readOnly = !1, R.readOnly = !1, O.focus() }, { enableHighAccuracy: !0, timeout: 15e3, maximumAge: 0 }) : (hideLoadingModal(), D && (D.innerHTML = "<strong>Notice:</strong> Geolocation not supported. Please enter coordinates manually.", D.style.color = "#fd7e14", D.style.display = "block"), P && (P.style.display = "block"), O.readOnly = !1, R.readOnly = !1) }) } let H = document.getElementById("images"), U = document.getElementById("new_main_image_index"); H && U && H.addEventListener("change", function (e) { if (U.innerHTML = '<option value="">-- Designate new main (optional) --</option>', e.target.files && e.target.files.length > 0) for (let t = 0; t < e.target.files.length; t++) { let n = document.createElement("option"); n.value = t; let s = e.target.files[t].name; n.textContent = `New Image ${t + 1}: ${s.length > 30 ? s.substring(0, 27) + "..." : s}`, U.appendChild(n) } }), document.querySelectorAll('input[type="checkbox"][id^="schedule_closed_"]').forEach(e => { let t = e.id.replace("schedule_closed_", ""); "function" == typeof toggleTimeInputs && toggleTimeInputs(e, t) }); let j = document.getElementById("eventWhatsappShareBtn"); j && j.addEventListener("click", function (e) { e.preventDefault(); let t = this.dataset.url || window.location.href, n = this.dataset.title || document.title, s = "https://api.whatsapp.com/send?text=" + encodeURIComponent(`Check out this event: ${n} - ${t}`); /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && (s = "https://wa.me/?text=" + encodeURIComponent(`Check out this event: ${n} - ${t}`)), window.open(s, "_blank") })
    });
</script>
